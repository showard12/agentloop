# AgentLoop

A Claude Code plugin that takes a project roadmap, generates a PRD and task backlog in VibeKanban, then autonomously executes tasks in a fresh-instance loop — picking, implementing, testing, committing, and updating tickets until everything is done.

## How It Works

```
┌─ You provide ──────────────────────────────────────────────────┐
│  Roadmap + testing instructions + setup docs                   │
├─ /onboard-agentloop generates ─────────────────────────────────┤
│  PRD → Development Plan → 1000+ VibeKanban tasks → Config     │
├─ agentloop.sh runs autonomously ───────────────────────────────┤
│  For each iteration (fresh Claude instance):                   │
│    1. Pick highest-priority available task from VK             │
│    2. Read context (plan, PRD, memory, codebase)               │
│    3. Implement the task                                       │
│    4. Verify acceptance criteria                               │
│    5. Run all tests                                            │
│    6. Commit with conventional format                          │
│    7. Update VK task → done                                    │
│    8. Save learnings to memory                                 │
│  Repeat until all tasks complete or rate limited               │
├─ Hookify rules enforce ───────────────────────────────────────┤
│  Must update VK | Must run tests | Must verify AC              │
├─ Memory persists across iterations ───────────────────────────┤
│  claude-mem (semantic) + progress.txt + git + VK descriptions  │
└────────────────────────────────────────────────────────────────┘
```

## Quick Start

### 1. Install

```bash
git clone https://github.com/showard12/agentloop.git
cd agentloop
chmod +x install.sh agentloop.sh
./install.sh
```

Or install manually:

```bash
# Add to ~/.claude/settings.json
{
  "enabledPlugins": {
    "agentloop@local": true
  }
}
```

### 2. Onboard a project

```bash
cd /path/to/your/project
claude
```

Then run:
```
/onboard-agentloop
```

This will interactively:
- Gather your roadmap, testing, and setup instructions
- Auto-detect your tech stack
- Generate a PRD and development plan
- Create VibeKanban tasks with priorities, dependencies, and acceptance criteria
- Install hookify enforcement rules
- Generate `agentloop.config.json`

### 3. Start the loop

```bash
./agentloop.sh
```

Watch it work. Each iteration spawns a fresh Claude instance that picks up one task, implements it, tests it, and commits it.

## Commands

| Command | Description |
|---------|-------------|
| `/onboard-agentloop` | Set up a new project (interactive, one-time) |
| `/loop-start` | Pre-flight checks and launch instructions |
| `/loop-once` | Run a single iteration in the current session (for debugging) |
| `/loop-status` | Check progress — task counts, per-epic breakdown |
| `/loop-pause` | Graceful stop (creates sentinel file, loop exits between iterations) |

## Architecture

### 5 Layers

| Layer | Component | Purpose |
|-------|-----------|---------|
| **Onboarding** | `/onboard-agentloop` | One-time project setup — PRD, plan, tasks, config |
| **Orchestration** | `agentloop.sh` | Bash loop spawning fresh Claude instances per iteration |
| **Execution** | Per-iteration prompt | 14-step workflow: pick → implement → verify → commit → update |
| **Enforcement** | Hookify rules | Warn/block if tests not run, VK not updated, AC not verified |
| **Memory** | 5 channels | claude-mem, progress.txt, git history, VK descriptions, AGENTS.md |

### Fresh Instance Pattern

Each iteration gets a clean context window (inspired by [Ralph Loop](https://github.com/anthropics/ralph-loop)). This prevents context drift across long autonomous runs and ensures each task starts with full available context rather than accumulated noise.

### Task Selection

Available tasks are ranked by:
1. **Dependencies satisfied** (gate — all deps must be `done`)
2. **Priority** — High > Medium > Low
3. **Complexity** — S > M > L (smaller tasks first for momentum)
4. **Epic order** — Earlier epics first
5. **Unblocking factor** — Tasks that unblock others get a boost

### Sprint-Based Chunking (1000+ tasks)

For large projects, configure `active_sprint.epics` in `agentloop.config.json` to focus on a subset of epics per sprint. The loop only considers tasks in active epics.

## Configuration

### `agentloop.config.json`

Generated by `/onboard-agentloop`. Key fields:

```json
{
  "project_name": "my-project",
  "vk_project_id": "uuid-from-vibekanban",
  "working_branch": "agentloop/sprint-1",
  "testing": {
    "commands": ["cd backend && pytest -v", "cd frontend && npx tsc --noEmit"],
    "required_before_commit": true
  },
  "loop": {
    "max_iterations": 100,
    "max_consecutive_failures": 3,
    "rate_limit_pause_seconds": 3600,
    "active_sprint": {
      "epics": [1, 2, 3],
      "description": "Foundation and core features"
    }
  },
  "memory": {
    "claude_mem_project": "my-project"
  }
}
```

### Hookify Rules

7 enforcement rules installed to `.claude/` during onboarding:

| Rule | Event | Action | Enforces |
|------|-------|--------|----------|
| `ticket-lifecycle` | stop | warn | Must update VK before stopping |
| `require-tests` | stop | warn | Must run test commands |
| `require-ac-verify` | stop | warn | Must verify acceptance criteria |
| `progress-update` | stop | warn | Should update progress file |
| `commit-discipline` | bash | warn | Commit message format reminder |
| `prevent-destructive` | bash | block | Blocks `git push --force`, `rm -rf` |
| `epic-memory` | stop | warn | Save memory summary on epic completion |

## Bundled Dependencies

### MCP Servers (auto-registered via `.mcp.json`)

| Server | Package | Required | Purpose |
|--------|---------|----------|---------|
| `vibe_kanban` | `claude-vibekanban` | Yes | Task management — source of truth |
| `mobile` | `@mobilenext/mobile-mcp` | No | iOS/Android simulator testing |

### Plugins

| Plugin | Required | Purpose |
|--------|----------|---------|
| `hookify` | Yes | Rule enforcement |
| `claude-mem` | No | Cross-session semantic memory |
| `superpowers` | No | Enhanced coding workflows |
| `code-review` | No | Automated code review |
| `pr-review-toolkit` | No | Specialized PR review agents |
| `dev-browser` | No | Chrome DevTools integration |

### CLI Tools

| Tool | Required | Install |
|------|----------|---------|
| `jq` | Yes | `brew install jq` |
| `bun` | No (for claude-mem) | `curl -fsSL https://bun.sh/install \| bash` |

## Plugin Structure

```
agentloop/
├── plugin.json                     # Manifest with dependency declarations
├── .mcp.json                       # MCP servers (vibekanban + mobile-mcp)
├── hooks.json                      # SessionStart context injection
├── install.sh                      # Full installer script
├── agentloop.sh                    # Main orchestration loop
├── agentloop.config.schema.json    # Config JSON schema
├── commands/
│   ├── onboard-agentloop.md        # Project setup (interactive)
│   ├── loop-start.md               # Pre-flight + launch
│   ├── loop-once.md                # Single iteration (debug)
│   ├── loop-status.md              # Progress check
│   └── loop-pause.md               # Graceful stop
├── skills/
│   └── autonomous-iteration/
│       └── SKILL.md                # 14-step iteration workflow
├── agents/
│   └── task-executor.md            # Agent for parallel delegation
├── hooks/                          # 7 hookify rule templates
│   ├── hookify.ticket-lifecycle.local.md
│   ├── hookify.require-tests.local.md
│   ├── hookify.require-ac-verify.local.md
│   ├── hookify.progress-update.local.md
│   ├── hookify.commit-discipline.local.md
│   ├── hookify.prevent-destructive.local.md
│   └── hookify.epic-memory.local.md
└── templates/
    ├── agentloop.config.json       # Config template
    └── agentloop-progress.txt      # Progress file template
```

## Monitoring

### Logs

```bash
# Real-time log tailing
tail -f agentloop-logs/latest.log

# All run logs
ls agentloop-logs/
```

### In-session

```
/loop-status    # Task counts, per-epic progress
/loop-once      # Run one iteration with step-by-step output
```

### Pausing

```
/loop-pause     # Creates .agentloop-pause sentinel
```

The loop checks for this file between iterations and exits gracefully.

## Safety

- **Fresh instances** — Each iteration starts clean, preventing runaway context
- **Circuit breaker** — Stops after N consecutive failures (no commits produced)
- **Rate limit detection** — Pauses on rate limits, resumes automatically
- **Hookify enforcement** — Can't skip tests, VK updates, or AC verification
- **Destructive command blocking** — `git push --force` and `rm -rf` are blocked
- **Pause sentinel** — Human can stop the loop at any time

## Troubleshooting

| Problem | Fix |
|---------|-----|
| `claude` CLI not found | `npm install -g @anthropic-ai/claude-code` |
| `jq` not found | `brew install jq` |
| VK MCP not connecting | Check `.mcp.json` or add to `~/.claude/settings.json` |
| claude-mem Chroma error | `cd ~/.claude/plugins/marketplaces/thedotmack && bun run worker:restart` |
| Chroma port conflict (8000) | Change `CLAUDE_MEM_CHROMA_PORT` to `8100` in `~/.claude-mem/settings.json`, restart worker |
| No logs created | Logging initializes early in script — check `agentloop-logs/latest.log` |
| Loop stops immediately | Check `agentloop-logs/` for errors; verify `agentloop.config.json` exists |
| Branch checkout fails | Loop continues on current branch with a warning |
| All tasks show as blocked | Check dependency graph in `docs/development-plan.md` |

## License

MIT
